<html>

<head>
    <title>OpenStreetMap Base Layer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/og.css" type="text/css"/>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        .ginput {
            position: relative;
            padding: 10px;
            display: flex;
            flex-direction: row;
        }

        .ginput input {
            width: 150px;
            font-size: 1.3em;
        }

        .ginput div {
            width: 100px;
        }
    </style>
</head>

<body>
<div id="earth" style="position: absolute; width:100%;height:100%"></div>
<div style="font-size: 1.3em; background: white; position: absolute; right:100px; top:20px;display: flex;flex-direction: column">
    <div class="ginput">
        <div>PITCH</div>
        <input type="number" class="gpitch" value="0"/>
    </div>
    <div class="ginput">
        <div>YAW</div>
        <input type="number" class="gyaw" value="0"/>
    </div>
    <div class="ginput">
        <div>ROLL</div>
        <input type="number" class="groll" value="0"/>
    </div>

    <br/>

    <div class="ginput">
        <div>SCALE_X</div>
        <input type="number" class="gscale_x" value="0" step="0.1"/>
    </div>
    <div class="ginput">
        <div>SCALE_Y</div>
        <input type="number" class="gscale_y" value="0" step="0.1"/>
    </div>
    <div class="ginput">
        <div>SCALE_Z</div>
        <input type="number" class="gscale_z" value="0" step="0.1"/>
    </div>

    <br/>

    <div class="ginput">
        <div>TRANS_X</div>
        <input type="number" class="gtrans_x" value="0" step="0.1"/>
    </div>
    <div class="ginput">
        <div>TRANS_Y</div>
        <input type="number" class="gtrans_y" value="0" step="0.1"/>
    </div>
    <div class="ginput">
        <div>TRANS_Z</div>
        <input type="number" class="gtrans_z" value="0" step="0.1"/>
    </div>

    <br/>

    <div class="ginput">
        <div>LENGTH</div>
        <input type="number" class="glength" value="1" step="0.1"/>
    </div>


</div>

<script type="module" id="og-sandbox-script">
    import {
        math,
        Globe,
        control,
        utils,
        LonLat,
        GlobusTerrain,
        Vector,
        OpenStreetMap,
        Entity,
        Bing,
        GlobusRgbTerrain,
        Object3d,
        EmptyTerrain,
        Mat4,
        Vec3
    } from "../../lib/@openglobus/og.esm.js";


    let axesLayer = new Vector("axesLayer", {
        //scaleByDistance: [1.0, 1.0, 1.0],
        scaleByDistance: [1, math.MAX32, 1],
        useLighting: false
    });

    function setPitch(a) {
        axesLayer.each((e) => {
            e.geoObject.setPitch(a);
            e.childrenNodes[0].geoObject.setPitch(a);
        });
    }

    function setYaw(a) {
        axesLayer.each((e) => {
            e.geoObject.setYaw(a);
            e.childrenNodes[0].geoObject.setYaw(a);
        });
    }

    function setRoll(a) {
        axesLayer.each((e) => {
            e.geoObject.setRoll(a);
            e.childrenNodes[0].geoObject.setRoll(a);
        });
    }

    function setScale(x, y, z) {
        axesLayer.each((e) => {
            e.geoObject.setScale3v(new Vec3(x, y, z));
            e.childrenNodes[0].geoObject.setScale3v(new Vec3(x, y, z));
        });
    }

    function setTranslate(x, y, z) {
        axesLayer.each((e) => {
            e.geoObject.setTranslate3v(new Vec3(x, y, z));
            e.childrenNodes[0].geoObject.setTranslate3v(new Vec3(x, y, z));
        });
    }

    async function main() {
        let sat = new Bing();
        let osm = new OpenStreetMap();

        let rot = new Mat4();

        const SCALE = 0.1;
        const SCALE_VEC = new Vec3(SCALE, SCALE, SCALE);

        const lineObjY = Object3d.createCylinder(0.0055, 0.0055, 0.83).scale(SCALE_VEC);
        const tipObjY = Object3d.createCylinder(0, 0.04, 0.17, 16, 16, false, true, 0, -0.17).scale(SCALE_VEC);

        rot.setRotation(new Vec3(1, 0, 0), 90 * Math.PI / 180);
        const lineObjZ = Object3d.createCylinder(0.0055, 0.0055, 0.83).scale(SCALE_VEC).applyMat4(rot);
        const tipObjZ = Object3d.createCylinder(0, 0.04, 0.17, 16, 16, false, true, 0, -0.17).scale(SCALE_VEC).applyMat4(rot);

        rot.setRotation(new Vec3(0, 0, 1), 90 * Math.PI / 180);
        const lineObjX = Object3d.createCylinder(0.0055, 0.0055, 0.83).scale(SCALE_VEC).applyMat4(rot);
        const tipObjX = Object3d.createCylinder(0, 0.04, 0.17, 16, 16, false, true, 0, -0.17).scale(SCALE_VEC).applyMat4(rot);

        function setArrowLength(axis, length) {
            let arrow = axis.childrenNodes[0];
            let spin = arrow.geoObject;
            let tip = arrow.childrenNodes[0].geoObject;

            const scale = (length - 0.17) / (1.0 - 0.17);
            const trans = length * SCALE;

            // X
            spin.setScale3v(new Vec3(scale, 1, 1));
            tip.setTranslate3v(new Vec3(trans, 0, 0));

            // Y
            arrow = axis.childrenNodes[1];
            spin = arrow.geoObject;
            tip = arrow.childrenNodes[0].geoObject;
            spin.setScale3v(new Vec3(1, scale, 1));
            tip.setTranslate3v(new Vec3(0, trans, 0));

            // Z
            arrow = axis.childrenNodes[2];
            spin = arrow.geoObject;
            tip = arrow.childrenNodes[0].geoObject;
            spin.setScale3v(new Vec3(1, 1, scale));
            tip.setTranslate3v(new Vec3(0, 0, -trans));
        }

        document.querySelector(".gpitch").addEventListener("input", (e) => {
            setPitch(Number(e.target.value));
        });
        document.querySelector(".gyaw").addEventListener("input", (e) => {
            setYaw(Number(e.target.value));
        });
        document.querySelector(".groll").addEventListener("input", (e) => {
            setRoll(Number(e.target.value));
        });

        function getScale() {
            return {
                x: Number(document.querySelector(".gscale_x").value),
                y: Number(document.querySelector(".gscale_y").value),
                z: Number(document.querySelector(".gscale_z").value)
            }
        }

        document.querySelector(".gscale_x").addEventListener("input", (e) => {
            let {x, y, z} = getScale();
            setScale(x, y, z);
        });
        document.querySelector(".gscale_y").addEventListener("input", (e) => {
            let {x, y, z} = getScale();
            setScale(x, y, z);
        });
        document.querySelector(".gscale_z").addEventListener("input", (e) => {
            let {x, y, z} = getScale();
            setScale(x, y, z);
        });

        function getTranslate() {
            return {
                x: Number(document.querySelector(".gtrans_x").value),
                y: Number(document.querySelector(".gtrans_y").value),
                z: Number(document.querySelector(".gtrans_z").value)
            }
        }

        document.querySelector(".gtrans_x").addEventListener("input", (e) => {
            let {x, y, z} = getTranslate();
            setTranslate(x, y, z);
        });
        document.querySelector(".gtrans_y").addEventListener("input", (e) => {
            let {x, y, z} = getTranslate();
            setTranslate(x, y, z);
        });
        document.querySelector(".gtrans_z").addEventListener("input", (e) => {
            let {x, y, z} = getTranslate();
            setTranslate(x, y, z);
        });

        document.querySelector(".glength").addEventListener("input", (e) => {
            let spinEntities = axesLayer.getEntities();

            for (let i = 0; i < spinEntities.length; i++) {
                setArrowLength(spinEntities[i], Number(e.target.value));
            }
        });

        for (let i = -90; i <= 90; i += 5) {
            for (let j = -180; j < 180; j += 10) {

                let axisEntity = new Entity();

                let arrowX = new Entity({
                    geoObject: {
                        color: "green",
                        scale: 1.0,
                        instanced: true,
                        tag: "line_x",
                        object3d: lineObjX,
                        yaw: 0,
                        pitch: 0
                    }
                });

                arrowX.appendChild(new Entity({
                    geoObject: {
                        color: "green",
                        scale: 1.0,
                        instanced: true,
                        tag: "tip_x",
                        object3d: tipObjX,
                        yaw: 0,
                        pitch: 0
                    }
                }));


                let arrowY = new Entity({
                    geoObject: {
                        color: "blue",
                        scale: 1.0,
                        instanced: true,
                        tag: "line_y",
                        object3d: lineObjY,
                        yaw: 0,
                        pitch: 0
                    }
                });

                arrowY.appendChild(new Entity({
                    geoObject: {
                        color: "blue",
                        scale: 1.0,
                        instanced: true,
                        tag: "tip_y",
                        object3d: tipObjY,
                        yaw: 0,
                        pitch: 0
                    }
                }));

                let arrowZ = new Entity({
                    geoObject: {
                        color: "red",
                        scale: 1.0,
                        instanced: true,
                        tag: "line_z",
                        object3d: lineObjZ,
                        yaw: 0,
                        pitch: 0
                    }
                });

                arrowZ.appendChild(new Entity({
                    geoObject: {
                        color: "red",
                        scale: 1.0,
                        instanced: true,
                        tag: "tip_z",
                        object3d: tipObjZ,
                        yaw: 0,
                        pitch: 0
                    }
                }));

                axisEntity.appendChild(arrowX);
                axisEntity.appendChild(arrowY);
                axisEntity.appendChild(arrowZ);

                axesLayer.add(axisEntity);
            }
        }

        document.querySelector(".gscale_x").value = SCALE;
        document.querySelector(".gscale_y").value = SCALE;
        document.querySelector(".gscale_z").value = SCALE;

        const globus = new Globe({
            target: "earth",
            name: "Earth",
            // terrain: new GlobusRgbTerrain("x5", {
            //     heightFactor: 5
            // }),
            terrain: new EmptyTerrain(),
            layers: [osm, sat, axesLayer],
            atmosphereEnabled: false,
            fontsSrc: "../../res/fonts",
            sun: {
                stopped: false
            }
        });

        globus.planet.addControl(new control.DebugInfo({}));
        globus.planet.addControl(new control.KeyboardNavigation());
        globus.planet.addControl(new control.ToggleWireframe());
        globus.planet.addControl(new control.LayerSwitcher());
        globus.planet.addControl(new control.Lighting());
        globus.planet.addControl(new control.TimelineControl());

        let arr = axesLayer.getEntities();
        let counter = 0;
        for (let i = -90; i <= 90; i += 5) {
            for (let j = -180; j < 180; j += 10) {
                let ai = arr[counter++];
                ai.setLonLat2(j, i, 25000);
                setArrowLength(ai, 1);
            }
        }
    }

    main()

</script>
</body>

</html>