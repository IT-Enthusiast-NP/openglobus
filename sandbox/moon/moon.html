<html>

<head>
    <title>OpenGlobus - Mars planet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../lib/@openglobus/og.css" type="text/css"/>
</head>

</html>

<body>
<div id="globus"></div>
<script type="module" id="og-sandbox-script">

    'use strict';

    import {
        Globe,
        EmptyTerrain,
        XYZ,
        control,
        RgbTerrain,
        quadTreeStrategyType,
        CanvasTiles,
        moon,
        Entity,
        Vector,
        LonLat
    } from "../../lib/@openglobus/og.esm.js";

    const mountains = new Vector("Mountains");
    const mountains2 = new Vector("Mountains");
    const catena = new Vector("Catena");
    const lacus = new Vector("Lacus");
    const maria = new Vector("maria");
    const vallis = new Vector("vallis");
    const sinusAndPaludes = new Vector("Sinus and Paludes");

    const sat = new XYZ("moon", {
        isBaseLayer: true,
        url: "https://{s}.terrain.openglobus.org/moon/sat/{z}/{x}/{y}.png",
        visibility: true,
        maxNativeZoom: 10,
        diffuse: [1.4, 1.4, 1.8],
        ambient: [0.01, 0.01, 0.02],
    });

    const appoloSat = new XYZ("APPOLO_SAT", {
        isBaseLayer: false,
        url: "https://{s}.terrain.openglobus.org/moon/sat_appolo/{z}/{x}/{y}.png",
        visibility: true,
        maxNativeZoom: 12,
        extent: [[30.4294, 19.9771], [30.9162, 20.3639]]
    });

    var highResTerrain = new RgbTerrain(null, {
        geoidSrc: null,
        maxZoom: 7,
        //maxNativeZoom: 7,
        url: "https://{s}.terrain.openglobus.org/moon/dem/{z}/{x}/{y}.png",
        heightFactor: 1
    });

    window.globe = new Globe({
        ellipsoid: moon,
        name: "mars",
        quadTreeStrategyPrototype: quadTreeStrategyType.equi,
        target: "globus",
        terrain: highResTerrain,
        layers: [sat, appoloSat, mountains, mountains2, catena, lacus, maria, vallis, sinusAndPaludes],
        nightTextureSrc: null,
        specularTextureSrc: null,
        atmosphereEnabled: false,
        gamma: 1.25,
        exposure: 2.195,
        fontsSrc: "../../res/fonts"
    });

    globe.planet.addControl(new control.AtmosphereConfig());
    globe.planet.addControl(new control.ToggleWireframe());
    globe.planet.addControl(new control.DebugInfo());
    globe.planet.addControl(new control.Lighting());
    globe.planet.addControl(new control.LayerSwitcher());
    globe.planet.addControl(new control.ElevationProfileControl());

    globe.planet.renderer.controls.SimpleSkyBackground.colorOne = "rgb(0, 0, 0)";
    globe.planet.renderer.controls.SimpleSkyBackground.colorTwo = "rgb(0, 0, 0)";


    fetch("./mountains.json").then((r) => r.json()).then((data) => {
        let entities = data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.height_km ? `${f.properties.name} - ${f.properties.height_km} km` : f.properties.name,
                "Ephesis-Regular",
                21)
        );
        mountains.setEntities(entities);
    });

    fetch("./mountains2.json").then((r) => r.json()).then((data) => {
        let entities = data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.height_km ? `${f.properties.name} - ${f.properties.height_km} km` : f.properties.name,
                "Ephesis-Regular",
                21)
        );
        mountains2.setEntities(entities);
    });

    fetch("./catena.json").then((r) => r.json()).then((data) => {
        let entities = data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.name,
                "Ephesis-Regular",
                21)
        );
        catena.setEntities(entities);
    });

    fetch("./lacus.json").then((r) => r.json()).then((data) => {
        let entities = data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.name,
                "Ephesis-Regular",
                21)
        );
        lacus.setEntities(entities);
    });


    fetch("./maria.json").then((r) => r.json()).then((data) => {
        let entities = data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.name,
                "Ephesis-Regular",
                21)
        );
        maria.setEntities(entities);
    });

    fetch("./vallis.json").then((r) => r.json()).then((data) => {
        let entities = data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.name,
                "Ephesis-Regular",
                21)
        );
        vallis.setEntities(entities);
    });

    fetch("./sinus_and_paludes.json").then((r) => r.json()).then((data) => {
        let entities = data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.name,
                "Ephesis-Regular",
                21)
        );
        sinusAndPaludes.setEntities(entities);
    });

    function createLabelEntity(lonlat, text, fontFace = "Ephesis-Regular", fontSize = 21) {
        const ell = globe.planet.ellipsoid;

        let ll = new LonLat(lonlat.lon, lonlat.lat, 1000);

        let res = new Entity({
            lonlat: ll,
            label: {
                size: fontSize,
                face: fontFace,
                text: text,
                align: "center",
                offset: [0, fontSize + 3]
            }
        });

        highResTerrain.getHeightAsync(ll, (h) => {
            ll.height = h + 1000;

            let ray = new Entity({
                ray: {
                    startPosition: ell.lonLatToCartesian(new LonLat(ll.lon, ll.lat, h)),
                    endPosition: ell.lonLatToCartesian(ll),
                    startColor: "white",
                    endColor: "white",
                    thickness: 2.5
                }
            });

            res.appendChild(ray);
            res.setLonLat(ll);
        });

        return res;
    };

</script>
</body>